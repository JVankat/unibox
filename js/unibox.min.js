var UniBox=function(){function J(c){if(c=c||window.event,void 0!==c){var d=c.keyCode||c.which,e=b.val();(27==d||13==d||9==d||e.length<p)&&(K(c),13==d&&void 0!==q&&a==-1&&q.call(this,e),a=-1)}else K(c),a=-1}function K(a){void 0!==u&&u.call(this,a,d.val()),d.removeClass("uniboxActive"),d.slideUp(n),S()}function L(a,b){var c=null;return function(){var d=this,e=arguments;clearTimeout(c),c=window.setTimeout(function(){a.apply(d,e)},b||50)}}function M(a,b){if(!k)return a;var c=b.replace(/[^a-zA-Z0-9äöüÄÖÜß]|\s+|\r?\n|\r/gim," ").replace(/[^a-zA-Z0-9äöüÄÖÜß]/g," ").split(" ");c.sort(function(a,b){return b.length-a.length});var d={};jQuery.each(c,function(b,c){if(!(c.length<1)){var e=a.match(new RegExp("(("+c+")(?!#<##|-\\d+#<##))(?!.*\\1)","gi"));if(null!=e)for(var f=0;f<e.length;f++){var g=e[f],h=g.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&");a=a.replace(new RegExp("("+h+")(?!#<##|-\\d+#<##)","g"),"##>#"+b+"-"+f+"#<##"),d["##>#"+b+"-"+f+"#<##"]='<span class="unibox-highlight">'+g+"</span>"}}});for(var e=Object.keys(d).reverse(),f=0;f<e.length;f++){var g=e[f],h=d[g];a=a.replace(new RegExp(g,"gi"),h)}return a}function N(a){return a.replace(/[ "§$%&\/(){}+*,.;|]/g,"_").toLowerCase()}function O(a){return String(a).replace(/[&<>"'\/]/g,function(a){return I[a]})}function P(e){if(13==y)return void J();var i=b.val(),k=O(i);d.html("");var p=!1,q=!1,s=Object.keys(e.suggests);if(B&&B.length>0&&(s=B,jQuery.each(Object.keys(e.suggests),function(a,b){jQuery.inArray(b,s)<0&&s.push(b)})),jQuery.each(s,function(a,b){var c=e.suggests[b];if(!c||0==c.length)return!0;var g=0;jQuery.each(s,function(a,c){var d=e.suggests[c];return!d||b===c||0==d.length||void(g+=d.length)});var i=jQuery('<div class="unibox-suggest-cluster unibox-suggest-'+N(b)+" "+("unibox-"+c.length+"-entries")+" "+(0==g?"unibox-single-suggestion-block":"")+'"></div>');if(b.replace(/_/,"").length>0&&c.length>0){var j=jQuery("<h4>"+b+"</h4>");i.append(j)}jQuery.each(c,function(a,c){var d='<div class="unibox-selectable">';if(void 0!=c.image){var e=0===c.image.length&&h?h:0===c.image.length||0===c.image.indexOf("/")||0===c.image.indexOf("http")?c.image:f+c.image;d+='<div class="unibox-selectable-img-container"><img src="'+e+'"/></div>'}if(void 0!=c.link&&""!=c.link?(d+='<a class="uniboxSearchContent" href="'+c.link+'">',d+=M(c.name,k),d+="</a>"):d+='<span class="uniboxSearchContent">'+M(c.name,k)+"</span>",void 0!=l){for(var g=l.match(/##(.*?)##/gi),j=l,n=!1,o=0;o<g.length;o++){var q=g[o];if(void 0!==q&&0!=q.length){var r=q.replace(/#/g,""),s=c[r];if(void 0!=s){var t=new RegExp(q,"g");j=j.replace(t,s)}else n=!0}}n||(d+='<div class="unibox-extra">'+j+"</div>")}d+='<div class="unibox-ca"></div></div>',void 0!==m&&(d=m.call(this,d,b,a,c));var u=jQuery(d);i.append(u),p=!0}),d.append(i)}),j=c.find(".unibox-selectable"),C&&C.length>0&&(j=[],jQuery.each(C,function(a,b){j=j.concat(c.find(".unibox-suggest-"+N(b)+":first .unibox-selectable").get())}),jQuery.each(jQuery.grep(Object.keys(e.suggests),function(a){if(C.indexOf(a)<0)return!0}),function(a,b){j=j.concat(c.find(".unibox-suggest-"+N(b)+":first .unibox-selectable").get())})),a=-1,jQuery(j).mousedown(function(){var a=jQuery(this).find(".uniboxSearchContent:first").text();b.val(a);var c=void 0;try{c=jQuery(this).find("a:first").attr("href")}catch(a){}void 0!=r&&r.call(this,a,c),J()}),c.find(".unibox-selectable .unibox-extra").click(function(a){a.stopPropagation()}),void 0!=e.words){e.words.length>0&&o.length>0&&("all"==x||"bottom"==x)&&(d.append("<h4>"+o+"</h4>"),p=!0);var t=[];jQuery.each(e.words,function(a,e){"all"!=x&&"bottom"!=x||(void 0!=e.overlayImage?d.append('<img class="unibox-vis" src="'+f+e.overlayImage+'" style="background-image: url(\''+f+e.image+"');background-size: 75%;background-repeat: no-repeat;background-position: center;\">"):void 0!=e.image&&d.append('<img class="unibox-vis" src="'+f+e.image+'">'));var h=c.find("#unibox-invisible");if(h.css("padding",b.css("padding")),h.html(k.replace(new RegExp(e.name,"gi"),"<span>"+e.name+"</span>")),"all"!=x&&"top"!=x||jQuery.inArray(e.image,w)!=-1)jQuery.inArray(e.image,w)>-1&&t.push(e.image);else{var i=c.find("#unibox-invisible span")[0];if(void 0!=i&&e.name.length>0&&void 0!=e.image){var j=jQuery(i).position().left;visImage=jQuery('<div class="unibox-ivf"><img src="'+f+e.image+'" alt="'+e.name+'"></div>'),visImage.css("left",Q().left+j-10),visImage.css("top",Q().top-b.outerHeight()+g),c.append(visImage),setTimeout(function(){c.find(".unibox-ivf").find("img").addClass("l")},10),t.push(e.image)}}}),w=t}jQuery("img").on("error",function(){h?jQuery(this).attr("src",h):jQuery(this).hide()}),V(),void 0==E||p||(p=!0,q=!0,d.append(E)),p?(d.is(":visible")?(d.addClass("uniboxActive"),d.css("left",Q().left),d.css("top",Q().top)):d.slideDown(n,function(){d.addClass("uniboxActive"),d.css("left",Q().left),d.css("top",Q().top)}),G&&!q&&d.append(G)):J()}function Q(){return{left:b.offset().left-c.offset().left,top:b.offset().top-c.offset().top+b.outerHeight()}}function R(){for(var a=c.find(".unibox-ivf img").map(function(){return jQuery(this).attr("src")}).get(),b=0;b<a.length;b++)jQuery.inArray(a[b].replace(f,""),w)==-1&&c.find('.unibox-ivf:has(img[src*="'+a[b]+'"])').remove()}function S(){w=[],c.find(".unibox-ivf").remove()}function T(d){if(b.val().length<=1&&S(),void 0!=s&&s.call(this,d,b.val()),37!=d.keyCode&&38!=d.keyCode&&39!=d.keyCode&&40!=d.keyCode&&13!=d.keyCode)return void R();if(38==d.keyCode&&a>0)a--;else if(40==d.keyCode)a++;else if(38==d.keyCode&&a<=0)a=(a!=-1?a-1:a)+j.length;else if((37==d.keyCode||39==d.keyCode)&&a>-1){a%=j.length;var g,e=jQuery(j[a]),f=e.closest(".unibox-suggest-cluster");if(37==d.keyCode?g=f.prev():39==d.keyCode&&(g=f.next()),g.hasClass("unibox-suggest-cluster")){var h=g.find("div.unibox-selectable")[0];a=jQuery("#unibox-suggest-box div.unibox-selectable").index(h)}}if(j.length>0&&a>-1){a%=j.length,jQuery(j).removeClass("active");var i=jQuery(j[a]);i.addClass("active")}if(13==d.keyCode){if(d.preventDefault(),d.stopPropagation(),void 0!=r){var k=b.val(),l=void 0;if(a!=-1){k=c.find(".unibox-selectable.active .uniboxSearchContent:first").text(),b.val(k);try{l=jQuery(c.find(".unibox-selectable.active")[0]).find("a").attr("href")}catch(a){}void 0!=r&&r.call(this,k,l)}}else a!=-1&&(window.location.href=jQuery(c.find(".unibox-selectable.active")[0]).find("a").attr("href"));return!1}a>-1&&d.preventDefault()}function U(c){if(18==y)return void(y=c.keyCode);if(y=c.keyCode,!((37==c.keyCode||39==c.keyCode)&&a>-1||38==c.keyCode||40==c.keyCode||13==c.keyCode||9==c.keyCode)){var d=b.val();46==y&&0==d.length&&S(),d.length>=p&&(z=d,jQuery.ajax({usedQuery:d,url:e+encodeURIComponent(d),dataType:"json",success:function(a){this.usedQuery==z&&P(a)}}))}}function V(){var a=jQuery("#unibox-suggest-box"),c=a.css("border-width").replace("px","");a.css("min-width",b.outerWidth()-2*c),void 0==D?a.css("max-width",b.outerWidth()-2*c):a.css("max-width",D-2*c),a.css("left",Q().left),a.css("top",Q().top)}var b,c,d,h,i,l,m,q,r,s,t,u,v,a=-1,e="",f="",g=-80,j=[],k=!0,n=300,o="",p=2,w=[],x="all",y=-1,z="",A=!1,B=[],C=[],D=void 0,E=void 0,F=void 0,G=void 0,H=!0,I={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return{updateSuggests:function(a){P(a)},updateSuggestUrl:function(a){e=a},hideSuggestBox:function(){J()},setIvfImagePath:function(a){f=a,"/"!=f.charAt(f.length-1)&&(f+="/")},changeInstantVisualFeedbackState:function(a){x=a},render:function(){V()},getText:function(){return b.val()},init:function(a,j){b=a,c=j.searchBoxContainer,k=j.highlight,l=j.extraHtml,m=j.lineCallback,e=j.suggestUrl,f=j.ivfImagePath,g=j.ivfImageOffset,h=j.missingErrorImage,i=j.throttleTime,n=j.animationSpeed,p=j.minChars,q=j.enterCallback,r=j.enterCallbackResult,s=j.typeCallback,t=j.focusCallback,u=j.blurCallback,v=j.placeholder,x=j.instantVisualFeedback,o=j.queryVisualizationHeadline,A=j.showDeleteAllButton,B=j.suggestOrder,C=j.suggestSelectionOrder,D=j.maxWidth,E=j.noSuggests,F=j.emptyQuerySuggests,G=j.showMoreResults,H=j.disableEventPropagationHTML,b.attr("autocomplete","off"),d=jQuery('<div id="unibox-suggest-box"></div>'),c.prepend(d);var w=c.css("position");"absolute"!=w&&c.css("position","relative");var y=d.css("border-width").replace("px","");d.css("min-width",b.outerWidth()-2*y),d.css("max-width",j.maxWidth-2*y),b.keydown(T),b.keydown(L(U,i)),b.keyup(J),b.focus(function(a){a=a||window.event,a.stopPropagation(),jQuery(this).val().length>0?U({keyCode:-1}):void 0!=F&&P(F),void 0!==t&&t.call(this,a,jQuery(this).val())}),d.mouseenter(function(){d.find(".unibox-selectable.active").removeClass("active")}),jQuery("html").click(function(a){d.hasClass("uniboxActive")}),b.keydown(function(a){a=a||window.event;a.keyCode||a.which}),b.focusout(function(a){a=a||window.event,setTimeout(function(){0===jQuery(document.activeElement).parents("#unibox-suggest-box").length},10)}),H&&(b.click(function(a){a.stopPropagation()}),d.click(function(a){a.stopPropagation()}));var z=b.attr("placeholder");if(v=z&&z.length>0?z:v,v&&v.length>0){var I=document.createElement("input");"placeholder"in I||(b.focus(function(){var a=jQuery(this).attr("placeholder");a&&a.length>0&&""!=a&&jQuery(this).val()==a&&jQuery(this).val("").removeClass("hasPlaceholder")}).blur(function(){var a=jQuery(this).attr("placeholder");a&&a.length>0&&""!=a&&(""==jQuery(this).val()||jQuery(this).val()==a)&&jQuery(this).val(a).addClass("hasPlaceholder")}),b.val(v)),b.attr("placeholder",v)}var K=jQuery('<div id="unibox-invisible">&nbsp;<span>&nbsp;</span></div>');if(c.append(K),A){var M=jQuery('<div id="unibox-dab-holder"><div id="unibox-dab"></div></div>');c.append(M),jQuery(M).mousedown(function(a){return(a||window.event).stopPropagation(),b.val(""),b.focus(),!1}),b.focus(function(){b.val().length>0?M.show():M.hide()}).blur(function(){M.hide()}).keydown(function(){jQuery(this).val().length>0&&jQuery(M).show()});var N=parseInt(b.css("paddingTop").replace("px","").trim()),O=b.outerHeight(),Q=parseInt(b.css("borderTopWidth").replace("px","").trim()),R=b.css("boxShadow").match(/\d{1,3}px/g),S=R&&R.length>2?parseInt(R[2].replace("px","").trim()):0;M.height(O-2*Q-S-N);var V=parseInt(b.css("paddingRight").replace("px","").trim());V=V>25?V:25,b.css("paddingRight",V);var W=Q+S+(b.offset().top-b.parent().offset().top-b.parent().scrollTop()),X=Math.abs(b[0].getBoundingClientRect().left-b.parent()[0].getBoundingClientRect().left)+b.outerWidth()-M.outerWidth()-Q-V;M.css("top",W),M.css("left",X)}"none"==x&&jQuery("#unibox-invisible").css("display","none")}}};!function(a){a.fn.unibox=function(b){var c=this.map(function(c,d){d=a(d);var e=a.extend({suggestUrl:"",ivfImagePath:"",ivfImageOffset:-80,missingErrorImage:void 0,queryVisualizationHeadline:"",highlight:!0,throttleTime:50,animationSpeed:300,instantVisualFeedback:"all",enterCallback:void 0,enterCallbackResult:void 0,typeCallback:void 0,focusCallback:void 0,blurCallback:void 0,placeholder:void 0,extraHtml:void 0,lineCallback:void 0,noSuggests:void 0,emptyQuerySuggests:void 0,minChars:3,maxWidth:d.outerWidth(),showDeleteAllButton:!1,suggestOrder:[],suggestSelectionOrder:[]},b);void 0==e.searchBoxContainerSelector?e.searchBoxContainer=d.parent():e.searchBoxContainer=a(e.searchBoxContainerSelector);var f=new UniBox;return f.init(d,e),f}),d=a.makeArray(c);return 1==d.length?d[0]:d}}(jQuery);