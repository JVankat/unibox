var UniBox=function(){var g=-1;var n;var v;var G;var A="";var p="";var E=-80;var B;var s;var h=[];var j=true;var d;var F=300;var r="";var t=2;var q;var z;var m;var x=[];var u="all";var e=-1;var i="";var f=false;var c=[];var w=[];function l(I){if(I!==undefined){var J=n.val();if(I.keyCode==9||I.keyCode==27||I.keyCode==13||J.length<t){G.slideUp(F);if(I.keyCode==13&&q!=undefined&&g==-1){q.call(this,J)}g=-1}}else{G.slideUp(F);g=-1}}function k(J,I){var K=null;return function(){var M=this,L=arguments;clearTimeout(K);K=window.setTimeout(function(){J.apply(M,L)},I||50)}}function C(J,I){if(!j){return J}var L=I.split(" ");var K={};jQuery.each(L,function(O,Q){if(Q.length<1){return}var P=J.match(new RegExp("("+Q+")","gi"));if(P!=null){for(var N=0;N<P.length;N++){var M=P[N];J=J.replace(new RegExp(M,"g"),"##"+O+"-"+N+"##");K["##"+O+"-"+N+"##"]="<span>"+M+"</span>"}}});jQuery.each(K,function(M,N){J=J.replace(new RegExp(M,"gi"),N)});return J}function H(M){if(e==13){l();return}var I=n.val();G.html("");var K=false;var L=Object.keys(M.suggests);if(c&&c.length>0){L=c;jQuery.each(Object.keys(M.suggests),function(N,O){if(jQuery.inArray(O,L)<0){L.push(O)}})}jQuery.each(L,function(N,P){var O=M.suggests[P];if(!O){return true}var R=jQuery('<div class="unibox-suggest-cluster unibox-suggest-'+P+'"></div>');if(P.replace(/_/,"").length>0&&O.length>0){var Q=jQuery("<h4>"+P+"</h4>");R.append(Q)}jQuery.each(O,function(aa,Y){var X='<div class="unibox-selectable">';if(Y.image!=undefined){var ac=Y.image.length===0&&B?B:Y.image.length===0||Y.image.indexOf("/")===0||Y.image.indexOf("http")===0?Y.image:p+Y.image;X+='<div class="unibox-selectable-img-container"><img src="'+ac+'"/></div>'}if(Y.link!=undefined){X+='<a href="'+Y.link+'">';X+=C(Y.name,I);X+="</a>"}else{X+="<span>"+C(Y.name,I)+"</span>"}if(d!=undefined){var Z=d.match(/##(.*?)##/gi);var W=d;var V=false;for(var T in Z){var U=Z[T].replace(/#/g,"");var S=Y[U];if(S==undefined){V=true;continue}var ad=new RegExp(Z[T],"g");W=W.replace(ad,S)}if(!V){X+='<div class="unibox-extra">'+W+"</div>"}}X+='<div class="unibox-ca"></div></div>';var ab=jQuery(X);R.append(ab);K=true});G.append(R)});if(w&&w.length>0){h=[];jQuery.each(w,function(N,O){h=h.concat(v.find(".unibox-suggest-"+O+":first .unibox-selectable").get())})}else{h=v.find(".unibox-selectable")}g=-1;jQuery(h).mousedown(function(){var O=jQuery(this).text();n.val(O);var N=undefined;try{N=jQuery(this).find("a:first").attr("href")}catch(P){}if(z!=undefined){z.call(this,O,N)}l()});v.find(".unibox-selectable .unibox-extra").click(function(){event.stopPropagation()});if(M.words.length>0&&r.length>0&&(u=="all"||u=="bottom")){G.append("<h4>"+r+"</h4>");K=true}var J=[];jQuery.each(M.words,function(O,R){if((u=="all"||u=="bottom")){if(R.overlayImage!=undefined){G.append('<img class="unibox-vis" src="'+p+R.overlayImage+'" style="background-image: url(\''+p+R.image+"');background-size: 75%;background-repeat: no-repeat;background-position: center;\">")}else{if(R.image!=undefined){G.append('<img class="unibox-vis" src="'+p+R.image+'">')}}}var Q=v.find("#unibox-invisible");Q.html(I.replace(new RegExp(R.name,"gi"),"<span>"+R.name+"</span>"));if((u=="all"||u=="top")&&jQuery.inArray(R.image,x)==-1){var P=v.find("#unibox-invisible span")[0];if(P!=undefined&&R.name.length>0&&R.image!=undefined){var N=jQuery(P).position().left;visImage=jQuery('<div class="unibox-ivf"><img src="'+p+R.image+'" alt="'+R.name+'"></div>');visImage.css("left",D().left+N-10);visImage.css("top",D().top-n.outerHeight()+E);v.append(visImage);setTimeout(function(){v.find(".unibox-ivf").find("img").addClass("l")},10);J.push(R.image)}}else{if(jQuery.inArray(R.image,x)>-1){J.push(R.image)}}});x=J;jQuery("img").error(function(){if(B){jQuery(this).attr("src",B)}else{jQuery(this).hide()}});G.css("left",D().left);G.css("top",D().top);if(K){G.slideDown(F,function(){G.css("left",D().left);G.css("top",D().top)})}else{l()}}function D(){return{left:n.offset().left-v.offset().left,top:n.offset().top-v.offset().top+n.outerHeight()}}function b(){var J=v.find(".unibox-ivf img").map(function(){return jQuery(this).attr("src")}).get();for(var I=0;I<J.length;I++){if(jQuery.inArray(J[I].replace(p,""),x)==-1){v.find('.unibox-ivf:has(img[src*="'+J[I]+'"])').remove()}}}function a(){x=[];v.find(".unibox-ivf").remove()}function o(K){if(n.val().length<=1){a()}if(K.keyCode!=38&&K.keyCode!=40&&K.keyCode!=13){b();return}if(K.keyCode==38&&g>0){g--}else{if(K.keyCode==40){g++}else{if(K.keyCode==38&&g<=0){g=((g!=-1)?g-1:g)+h.length}}}if(h.length>0&&g>-1){g=g%h.length;jQuery(h).removeClass("active");var J=jQuery(h[g]);J.addClass("active")}if(K.keyCode==13){if(z!=undefined){var M=n.val();var I=undefined;if(g!=-1){M=jQuery(v.find(".unibox-selectable.active")[0]).text();n.val(M);try{I=jQuery(v.find(".unibox-selectable.active")[0]).find("a").attr("href")}catch(L){}if(z!=undefined){z.call(this,M,I)}}}else{if(g!=-1){window.location.href=jQuery(v.find(".unibox-selectable.active")[0]).find("a").attr("href")}}return false}}function y(I){if(e==18){e=I.keyCode;return}e=I.keyCode;if(I.keyCode==38||I.keyCode==40||I.keyCode==13||I.keyCode==9){return}var J=n.val();if(e==46&&J.length==0){a()}if(J.length>=t){i=J;jQuery.ajax({usedQuery:J,url:A+encodeURIComponent(J),dataType:"json",success:function(K){if(this.usedQuery==i){H(K)}}})}}return{updateSuggestUrl:function(I){A=I},hideSuggestBox:function(){l()},setIvfImagePath:function(I){p=I;if(p.charAt(p.length-1)!="/"){p+="/"}},changeInstantVisualFeedbackState:function(I){u=I},init:function(U,W){n=U;v=n.parent();j=W.highlight;d=W.extraHtml;A=W.suggestUrl;p=W.ivfImagePath;E=W.ivfImageOffset;B=W.missingErrorImage;s=W.throttleTime;F=W.animationSpeed;t=W.minChars;q=W.enterCallback;z=W.enterCallbackResult;m=W.placeholder;u=W.instantVisualFeedback;r=W.queryVisualizationHeadline;f=W.showDeleteAllButton;c=W.suggestOrder;w=W.suggestSelectionOrder;n.attr("autocomplete","off");G=jQuery('<div id="unibox-suggest-box"></div>');v.append(G);var S=v.css("position");if(S!="absolute"){v.css("position","relative")}var N=G.css("border-width").replace("px","");G.css("min-width",n.outerWidth()-2*N);G.css("max-width",W.maxWidth-2*N);n.keydown(o);n.keydown(k(y,s));n.keyup(l);n.blur(function(){G.slideUp(F)});G.mouseenter(function(){G.find(".unibox-selectable.active").removeClass("active")});jQuery("html").click(function(){G.slideUp(F)});G.click(function(X){X.stopPropagation()});var J=n.attr("placeholder");m=J&&J.length>0?J:m;if(m&&m.length>0){var P=document.createElement("input");if(!("placeholder" in P)){n.focus(function(){var X=jQuery(this).attr("placeholder");if((X)&&(X.length>0)&&(X!="")&&jQuery(this).val()==X){jQuery(this).val("").removeClass("hasPlaceholder")}}).blur(function(){var X=jQuery(this).attr("placeholder");if((X)&&(X.length>0)&&(X!="")&&(jQuery(this).val()==""||jQuery(this).val()==X)){jQuery(this).val(X).addClass("hasPlaceholder")}});n.val(m)}n.attr("placeholder",m)}var V=jQuery('<div id="unibox-invisible">&nbsp;<span>&nbsp;</span></div>');n.parent().append(V);if(f){var T=jQuery('<div id="unibox-dab-holder"><div id="unibox-dab"></div></div>');v.append(T);jQuery(T).mousedown(function(X){(X||window.event).stopPropagation();n.val("");n.focus();return false});n.focus(function(){if(n.val().length>0){T.show()}else{T.hide()}}).blur(function(){T.hide()}).keydown(function(){if(jQuery(this).val().length>0){jQuery(T).show()}});var R=parseInt(n.css("paddingTop").replace("px","").trim());var Q=n.outerHeight();var O=parseInt(n.css("borderTopWidth").replace("px","").trim());var L=n.css("boxShadow").match(/\d{1,3}px/g);var K=(L&&L.length>2)?parseInt(L[2].replace("px","").trim()):0;T.height(Q-(2*O)-K-R);var I=parseInt(n.css("paddingRight").replace("px","").trim());n.css("paddingRight",(I>25)?I:25);var M=O+K+(n.offset().top-n.parent().offset().top-n.parent().scrollTop());T.css("top",M);T.css("left",n.outerWidth()-T.outerWidth()-O)}if(u=="none"){jQuery("#unibox-invisible").css("display","none")}}}};(function(a){a.fn.unibox=function(b){var f=a(this.selector);var d=[];for(var c=0;c<f.length;c++){var h=a(f[c]);var e=a.extend({suggestUrl:"",ivfImagePath:"",ivfImageOffset:-80,missingErrorImage:undefined,queryVisualizationHeadline:"",highlight:true,throttleTime:50,animationSpeed:300,instantVisualFeedback:"all",enterCallback:undefined,enterCallbackResult:undefined,placeholder:undefined,extraHtml:undefined,minChars:3,maxWidth:h.outerWidth(),showDeleteAllButton:false,suggestOrder:[],suggestSelectionOrder:[]},b);var g=new UniBox();g.init(h,e);d.push(g)}if(d.length==1){return d[0]}return d}}(jQuery));